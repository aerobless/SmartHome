
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="How to automatically export Apple Health data into InfluxDB with Home Assistant and Node RED.">
      
      
      
        <meta name="author" content="Theo Winter">
      
      
        <link rel="canonical" href="https://sixtymeters.com/automations/exporting-apple-health-data-to-home-assistant/">
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.1.2, mkdocs-material-7.1.5">
    
    
      
        <title>Exporting Apple Health Data to Home Assistant - SixtyMeters - Smart Home</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.bde7dde4.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.ef6f36e2.min.css">
        
      
    
    
    
      
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>:root{--md-text-font-family:"Roboto";--md-code-font-family:"Roboto Mono"}</style>
      
    
    
    
    
<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-5LS80XX2C3"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-5LS80XX2C3');
</script>

    
  
    <meta property="og:title" content="Exporting Apple Health Data to Home Assistant" />
    <meta name="twitter:title" content="Exporting Apple Health Data to Home Assistant" />
    <meta property="og:description" content="How to automatically export Apple Health data into InfluxDB with Home Assistant and Node RED." />
    <meta property="og:image" content="https://sixtymeters.com/automations/images/grafana-twittercard.png" />
    <meta name="twitter:image" content="https://sixtymeters.com/automations/images/grafana-twittercard.png" />
  
  <meta property="og:type" content="website" />
  <meta property="og:url" content="https://sixtymeters.com/automations/exporting-apple-health-data-to-home-assistant/" />
  <meta property="og:image:type" content="image/png" />
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:site" content="eletiy" />
  <meta name="twitter:creator" content="eletiy" />

  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="none" data-md-color-accent="none">
  
    
    <script>function __prefix(e){return new URL("../..",location).pathname+"."+e}function __get(e,t=localStorage){return JSON.parse(t.getItem(__prefix(e)))}</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#theres-an-app-for-that" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="SixtyMeters - Smart Home" class="md-header__button md-logo" aria-label="SixtyMeters - Smart Home" data-md-component="logo">
      
  <img src="../../logo.svg" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            SixtyMeters - Smart Home
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Exporting Apple Health Data to Home Assistant
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" data-md-state="active" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        
<a href="https://github.com/aerobless/SmartHome/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    aerobless/SmartHome
  </div>
</a>
      </div>
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-tabs__inner md-grid">
    <ul class="md-tabs__list">
      
        
  
  


  <li class="md-tabs__item">
    <a href="../.." class="md-tabs__link">
      Home
    </a>
  </li>

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../hardware/" class="md-tabs__link">
        Hardware
      </a>
    </li>
  

      
        
  
  


  
  
  
    <li class="md-tabs__item">
      <a href="../../software/home-assistant/" class="md-tabs__link">
        Software
      </a>
    </li>
  

      
        
  
  
    
  


  
  
  
    <li class="md-tabs__item">
      <a href="../" class="md-tabs__link md-tabs__link--active">
        Automations
      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

  


  

<nav class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="SixtyMeters - Smart Home" class="md-nav__button md-logo" aria-label="SixtyMeters - Smart Home" data-md-component="logo">
      
  <img src="../../logo.svg" alt="logo">

    </a>
    SixtyMeters - Smart Home
  </label>
  
    <div class="md-nav__source">
      
<a href="https://github.com/aerobless/SmartHome/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    aerobless/SmartHome
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        Home
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_2" type="checkbox" id="__nav_2" >
      
      <label class="md-nav__link" for="__nav_2">
        Hardware
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Hardware" data-md-level="1">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          Hardware
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../hardware/" class="md-nav__link">
        Overview
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../hardware/computers/" class="md-nav__link">
        Computers
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../hardware/sensors/" class="md-nav__link">
        Sensors
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../hardware/power-switches/" class="md-nav__link">
        Power Switches
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../hardware/voice-assistants/" class="md-nav__link">
        Voice Assistants
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../hardware/lights/" class="md-nav__link">
        Lights
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../hardware/networking/" class="md-nav__link">
        Networking & Mesh
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../hardware/entertainment/" class="md-nav__link">
        TV & Entertainment
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../hardware/locks/" class="md-nav__link">
        Locks
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../hardware/blinds/" class="md-nav__link">
        Blinds
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../hardware/nfc/" class="md-nav__link">
        NFC
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../hardware/miscellaneous/" class="md-nav__link">
        Miscellaneous
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3" type="checkbox" id="__nav_3" >
      
      <label class="md-nav__link" for="__nav_3">
        Software
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Software" data-md-level="1">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          Software
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../software/home-assistant/" class="md-nav__link">
        Home Assistant
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../software/knx/" class="md-nav__link">
        KNX
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../software/node-red/" class="md-nav__link">
        Node-RED
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../../software/proxmox/" class="md-nav__link">
        Proxmox
      </a>
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4" type="checkbox" id="__nav_4" checked>
      
      <label class="md-nav__link" for="__nav_4">
        Automations
        <span class="md-nav__icon md-icon"></span>
      </label>
      <nav class="md-nav" aria-label="Automations" data-md-level="1">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          Automations
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
  
  
  
    <li class="md-nav__item">
      <a href="../" class="md-nav__link">
        Overview
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../getting-started-with-node-red/" class="md-nav__link">
        Getting started
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../node-red-utilities/" class="md-nav__link">
        Node-RED Utilities
      </a>
    </li>
  

          
            
  
  
  
    <li class="md-nav__item">
      <a href="../examples/" class="md-nav__link">
        Automation Examples
      </a>
    </li>
  

          
            
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Exporting Apple Health data to Home Assistant
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Exporting Apple Health data to Home Assistant
      </a>
      
        
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#theres-an-app-for-that" class="md-nav__link">
    There's an app for that
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#setting-up-an-endpoint" class="md-nav__link">
    Setting up an endpoint
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#storing-the-data-in-influxdb" class="md-nav__link">
    Storing the data in InfluxDB
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#historical-data" class="md-nav__link">
    Historical data
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#workout-data" class="md-nav__link">
    Workout data
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/aerobless/SmartHome/edit/master/docs/automations/exporting-apple-health-data-to-home-assistant.md" title="Edit this page" class="md-content__button md-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/></svg>
                  </a>
                
                
                  <h1>Exporting Apple Health data to Home Assistant</h1>
                
                <p>I've recently started using the excellent Influx <a href="/software/home-assistant/#addons">addon</a> to store data that I want to keep around for a long time. Influx is a time series database which means that it has been optimized to store data through associated pairs of time(s) and value(s). To make use of that data stored in InfluxDB I use a Grafana Dashboard. (Another excellent <a href="/software/home-assistant/#addons">addon</a> for Home Assistant 😄)</p>
<p><img alt="Grafana Dashboard" src="../images/grafana_health_stats.png" /></p>
<p>By gathering and analyzing health data you can get some interesting insights about yourself. For example whether there's a correlation between sleep duration and how much your work out. Or if the weather has an effect on your mood. Of course that data could also be used for automations.. e.g. the waking time of the alarm clock is automatically offset by 30min if you went to bed late. With tons of data there's basically no limit to what you can do.</p>
<p>Sadly the Home Assistant app for iOS doesn't have access to Apple Health data and likely never will. This is due to Apple's privacy policy that only allows access to health data for apps that have a specific health focus. This is discussed in <a href="https://github.com/home-assistant/iOS/issues/85">this feature request</a> for the Home Assistant app.</p>
<h2 id="theres-an-app-for-that">There's an app for that<a class="headerlink" href="#theres-an-app-for-that" title="Permanent link">&para;</a></h2>
<p>Luckily someone made an app to automatically export Apple Health data to a user defined web endpoint. <a href="https://www.healthexportapp.com/">You can find it here</a>. The data is uploaded in a POST request as JSON. The user can define how many days of data should be uploaded and in what time interval the data should be aggregated.
Personally I'm uploading the data of "yesterday until now" in a daily aggregation format. So for every measurement there's a total value of yesterday and a up-to-now value for today.</p>
<p><img alt="iOS App: Health Export App" src="../images/ios-apple-health-auto-export.png" style="width:300px" /></p>
<h2 id="setting-up-an-endpoint">Setting up an endpoint<a class="headerlink" href="#setting-up-an-endpoint" title="Permanent link">&para;</a></h2>
<p>I'm using the webhook node in Node RED to create an endpoint for the POST request of the health export app. The webhook node is really straight forward to use, all you do is set an id for the hook and then you can send data to <code>https://&lt;ip&gt;:&lt;port&gt;/api/webhook/YOUR_ID</code>. To test this right away it's best to use a debug node to simply print the json coming in.</p>
<p>The data coming in should look like this.
<div class="highlight"><pre><span></span><code><span class="p">{</span>
    <span class="nt">&quot;data&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="nt">&quot;metrics&quot;</span><span class="p">:</span> <span class="p">[</span>
            <span class="p">{</span>
                <span class="nt">&quot;name&quot;</span><span class="p">:</span> <span class="s2">&quot;active_energy&quot;</span><span class="p">,</span>
                <span class="nt">&quot;units&quot;</span> <span class="nt">&quot;kJ&quot;</span>
                <span class="nt">&quot;data&quot;</span><span class="p">:</span> <span class="p">[</span>
                    <span class="p">{</span>
                        <span class="nt">&quot;qty&quot;</span><span class="p">:</span> <span class="mi">1599</span><span class="p">,</span>
                        <span class="nt">&quot;date&quot;</span><span class="p">:</span> <span class="s2">&quot;2021-03-17 00:00:00 +0100&quot;</span>
                    <span class="p">},</span>
                    <span class="p">{</span>
                        <span class="nt">&quot;qty&quot;</span><span class="p">:</span> <span class="mi">1200</span><span class="p">,</span>
                        <span class="nt">&quot;date&quot;</span><span class="p">:</span> <span class="s2">&quot;2021-03-16 00:00:00 +0100&quot;</span>
                    <span class="p">}</span>

                <span class="p">]</span>

            <span class="p">},</span>
            <span class="err">...</span>
        <span class="p">],</span>
        <span class="nt">&quot;workouts&quot;</span><span class="p">:</span> <span class="p">[]</span>
    <span class="p">}</span>
<span class="p">}</span>
</code></pre></div></p>
<h2 id="storing-the-data-in-influxdb">Storing the data in InfluxDB<a class="headerlink" href="#storing-the-data-in-influxdb" title="Permanent link">&para;</a></h2>
<p>Writing to Influx is fairly simple. I'm using the "<a href="https://flows.nodered.org/node/node-red-contrib-influxdb">influx batch node</a>" to write all the measurements to InfluxDB in one go. But you could also split them up into seperate messages and use the regular "influx out" node instead.</p>
<p><img alt="Node RED Apple Health to Influx Export Flow" src="../images/health-export-to-influx-db.png" /></p>
<p>Of course the InfluxDB Batch node can't consume the data just the way it comes out of the export json.. so we need to do a little bit of mapping before we can forward it. </p>
<p>This is the content of the function node you can see above. It transforms the json provided by the endpoint into one that can be imported via the batch node.
<div class="highlight"><pre><span></span><code><span class="nx">msg</span><span class="p">.</span><span class="nx">payload</span> <span class="o">=</span> <span class="nx">msg</span><span class="p">.</span><span class="nx">payload</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">metrics</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">metric</span> <span class="p">=&gt;</span> <span class="p">{</span>

    <span class="c1">//e.g. measurement for 01.01.2020 of active_energy</span>
    <span class="k">return</span> <span class="nx">metric</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">actualMeasurement</span> <span class="p">=&gt;</span>
       <span class="p">({</span>
            <span class="nx">measurement</span><span class="o">:</span> <span class="nx">metric</span><span class="p">.</span><span class="nx">units</span><span class="p">,</span> <span class="c1">//kJ</span>
            <span class="nx">fields</span><span class="o">:</span> <span class="p">{</span>
                <span class="p">...(</span><span class="nx">actualMeasurement</span><span class="p">.</span><span class="nx">qty</span> <span class="o">&amp;&amp;</span> <span class="p">{</span><span class="nx">value</span><span class="o">:</span> <span class="nx">actualMeasurement</span><span class="p">.</span><span class="nx">qty</span><span class="p">}),</span> <span class="c1">//2500 default</span>
                <span class="p">...(</span><span class="nx">actualMeasurement</span><span class="p">.</span><span class="nx">Avg</span> <span class="o">&amp;&amp;</span> <span class="p">{</span><span class="nx">Avg</span><span class="o">:</span> <span class="nx">actualMeasurement</span><span class="p">.</span><span class="nx">Avg</span><span class="p">}),</span> <span class="c1">//Heartrate special</span>
                <span class="p">...(</span><span class="nx">actualMeasurement</span><span class="p">.</span><span class="nx">Max</span> <span class="o">&amp;&amp;</span> <span class="p">{</span><span class="nx">Max</span><span class="o">:</span> <span class="nx">actualMeasurement</span><span class="p">.</span><span class="nx">Max</span><span class="p">}),</span> <span class="c1">//Heartrate special</span>
                <span class="p">...(</span><span class="nx">actualMeasurement</span><span class="p">.</span><span class="nx">Min</span> <span class="o">&amp;&amp;</span> <span class="p">{</span><span class="nx">Min</span><span class="o">:</span> <span class="nx">actualMeasurement</span><span class="p">.</span><span class="nx">Min</span><span class="p">}),</span> <span class="c1">//Heartrate special</span>
                <span class="p">...(</span><span class="nx">actualMeasurement</span><span class="p">.</span><span class="nx">inBed</span> <span class="o">&amp;&amp;</span> <span class="p">{</span><span class="nx">inBed</span><span class="o">:</span> <span class="nx">actualMeasurement</span><span class="p">.</span><span class="nx">inBed</span><span class="p">}),</span> <span class="c1">//Bed special</span>
                <span class="p">...(</span><span class="nx">actualMeasurement</span><span class="p">.</span><span class="nx">asleep</span> <span class="o">&amp;&amp;</span> <span class="p">{</span><span class="nx">asleep</span><span class="o">:</span> <span class="nx">actualMeasurement</span><span class="p">.</span><span class="nx">asleep</span><span class="p">}),</span> <span class="c1">//Bed special</span>
                <span class="p">...(</span><span class="nx">actualMeasurement</span><span class="p">.</span><span class="nx">heartRateVariation</span> <span class="o">&amp;&amp;</span> <span class="p">{</span> <span class="nx">value</span><span class="o">:</span> <span class="nx">measurement</span><span class="p">.</span><span class="nx">heartRateVariation</span><span class="p">.</span><span class="nx">length</span> <span class="p">}),</span> <span class="c1">//irregular heartrate special</span>
            <span class="p">},</span>
            <span class="nx">tags</span><span class="o">:</span><span class="p">{</span>
                <span class="nx">entity_id</span><span class="o">:</span> <span class="nx">metric</span><span class="p">.</span><span class="nx">name</span><span class="p">,</span> <span class="c1">//active_energy</span>
                <span class="p">...(</span><span class="nx">actualMeasurement</span><span class="p">.</span><span class="nx">sleepSource</span> <span class="o">&amp;&amp;</span> <span class="p">{</span><span class="nx">sleepSource</span><span class="o">:</span> <span class="nx">actualMeasurement</span><span class="p">.</span><span class="nx">sleepSource</span><span class="p">}),</span> <span class="c1">//Bed special</span>
                <span class="p">...(</span><span class="nx">actualMeasurement</span><span class="p">.</span><span class="nx">inBedSource</span> <span class="o">&amp;&amp;</span> <span class="p">{</span><span class="nx">inBedSource</span><span class="o">:</span> <span class="nx">actualMeasurement</span><span class="p">.</span><span class="nx">inBedSource</span><span class="p">})</span> <span class="c1">//Bed special</span>
            <span class="p">},</span>
            <span class="nx">timestamp</span><span class="o">:</span> <span class="nb">Date</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">actualMeasurement</span><span class="p">.</span><span class="nx">date</span><span class="p">)</span> <span class="c1">//2021-03-16 00:00:00 +0100</span>
        <span class="p">}))</span>
    <span class="p">})</span>
    <span class="p">.</span><span class="nx">flat</span><span class="p">()</span> <span class="c1">// we&#39;ve created array for each metric consisting of array of measurements</span>
    <span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="nx">e</span> <span class="p">=&gt;</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">fields</span><span class="p">).</span><span class="nx">length</span><span class="p">)</span> <span class="c1">// only return entries with fields</span>

<span class="k">return</span> <span class="nx">msg</span><span class="p">;</span>
</code></pre></div></p>
<div class="admonition info">
<p class="admonition-title">Info</p>
<p>Since I want to be able to mix &amp; match data from Home Assistant my mapping function is written to produce an output similar to what Home Assistants sensors would
natively store in InfluxDB. Alternatively you could setup a dedicated DB for apple health data. Then it may make sense to choose a different style of mapping the data.
See the suggestion by <a href="http://disq.us/p/2h0cehp">wvk</a> in the comments below. Wvk also wrote an updated function which you can find <a href="https://gist.github.com/wivaku/2d0dde069b4575a85e2d0c8f90342043">here</a>.</p>
</div>
<p>Now for the batch node itself you should choose the following settings:</p>
<ul>
<li><strong>Server:</strong> [v1.x] Home Assistant Influx<ul>
<li><strong>Version:</strong> 1.x</li>
<li><strong>Host:</strong> 127.0.0.1 <strong>Port:</strong> 8086</li>
<li><strong>Database:</strong> homeassistant</li>
</ul>
</li>
<li><strong>Advanced Query Options</strong><ul>
<li><strong>Time Precision:</strong> Miliseconds (ms)</li>
</ul>
</li>
</ul>
<p>If writing to the InfluxDB doesn't work for some reason then error logs should appear in the debug panel of Node RED.</p>
<h2 id="historical-data">Historical data<a class="headerlink" href="#historical-data" title="Permanent link">&para;</a></h2>
<p>The Node RED flow we've just set up is fully capable of importing historic data as well. So you can use the Manual Sync function of the Health Export app to upload all your existing Apple Health data as well. With a bit of experimentation I've found out that about half a month worth of data can be imported in one go. More then that and the endpoint doesn't seem to be able to handle the request anymore. So you need to do a few requests if you want to upload a years worth of data.. but I think it's not too much of a hassle given that it's a one time thing and all future data is uploaded automatically.</p>
<p><img alt="Steps graph in Grafana" src="../images/steps-2020-grafana.png" /></p>
<h2 id="workout-data">Workout data<a class="headerlink" href="#workout-data" title="Permanent link">&para;</a></h2>
<p>Now the healthexport app will also export workout data. It looks slightly different but we can use a similar mapping technique as before to map the data
into something consistent with Home Assistant.</p>
<p><div class="highlight"><pre><span></span><code><span class="nx">msg</span><span class="p">.</span><span class="nx">payload</span> <span class="o">=</span> <span class="nx">msg</span><span class="p">.</span><span class="nx">payload</span><span class="p">.</span><span class="nx">data</span><span class="p">.</span><span class="nx">workouts</span><span class="p">.</span><span class="nx">map</span><span class="p">(</span><span class="nx">workout</span> <span class="p">=&gt;</span>
    <span class="p">({</span>
        <span class="nx">measurement</span><span class="o">:</span> <span class="s2">&quot;workout&quot;</span><span class="p">,</span>
        <span class="nx">fields</span><span class="o">:</span> <span class="p">{</span>
            <span class="p">...(</span><span class="nx">workout</span><span class="p">.</span><span class="nx">humidity</span><span class="p">.</span><span class="nx">qty</span> <span class="o">&amp;&amp;</span> <span class="p">{</span><span class="nx">workout_humidity_percentage</span><span class="o">:</span> <span class="nx">workout</span><span class="p">.</span><span class="nx">humidity</span><span class="p">.</span><span class="nx">qty</span><span class="p">}),</span> <span class="c1">//62</span>
            <span class="p">...(</span><span class="nx">workout</span><span class="p">.</span><span class="nx">flightsClimbed</span><span class="p">.</span><span class="nx">qty</span> <span class="o">&amp;&amp;</span> <span class="p">{</span><span class="nx">workout_flightsClimbedCount_stairs</span><span class="o">:</span> <span class="nx">workout</span><span class="p">.</span><span class="nx">flightsClimbed</span><span class="p">.</span><span class="nx">qty</span><span class="p">}),</span> <span class="c1">//0</span>
            <span class="p">...(</span><span class="nx">workout</span><span class="p">.</span><span class="nx">swimCadence</span><span class="p">.</span><span class="nx">qty</span> <span class="o">&amp;&amp;</span> <span class="p">{</span><span class="nx">workout_swimCadence_spm</span><span class="o">:</span> <span class="nx">workout</span><span class="p">.</span><span class="nx">swimCadence</span><span class="p">.</span><span class="nx">qty</span><span class="p">}),</span> <span class="c1">//0</span>
            <span class="p">...(</span><span class="nx">workout</span><span class="p">.</span><span class="nx">totalSwimmingStrokeCount</span><span class="p">.</span><span class="nx">qty</span> <span class="o">&amp;&amp;</span> <span class="p">{</span><span class="nx">workout_totalSwimmingStrokeCount_strokes</span><span class="o">:</span> <span class="nx">workout</span><span class="p">.</span><span class="nx">totalSwimmingStrokeCount</span><span class="p">.</span><span class="nx">qty</span><span class="p">}),</span> <span class="c1">//0   </span>
            <span class="p">...(</span><span class="nx">workout</span><span class="p">.</span><span class="nx">intensity</span><span class="p">.</span><span class="nx">qty</span> <span class="o">&amp;&amp;</span> <span class="p">{</span><span class="nx">workout_intensity_met</span><span class="o">:</span> <span class="nx">workout</span><span class="p">.</span><span class="nx">intensity</span><span class="p">.</span><span class="nx">qty</span><span class="p">}),</span> <span class="c1">//8.7823</span>
            <span class="p">...(</span><span class="nx">workout</span><span class="p">.</span><span class="nx">temperature</span><span class="p">.</span><span class="nx">qty</span> <span class="o">&amp;&amp;</span> <span class="p">{</span><span class="nx">workout_temperature_degC</span><span class="o">:</span> <span class="nx">workout</span><span class="p">.</span><span class="nx">temperature</span><span class="p">.</span><span class="nx">qty</span><span class="p">}),</span> <span class="c1">//3.9</span>
            <span class="p">...(</span><span class="nx">workout</span><span class="p">.</span><span class="nx">avgHeartRate</span><span class="p">.</span><span class="nx">qty</span> <span class="o">&amp;&amp;</span> <span class="p">{</span><span class="nx">workout_avgHeartRate_bpm</span><span class="o">:</span> <span class="nx">workout</span><span class="p">.</span><span class="nx">avgHeartRate</span><span class="p">.</span><span class="nx">qty</span><span class="p">}),</span> <span class="c1">//140.78</span>
            <span class="p">...(</span><span class="nx">workout</span><span class="p">.</span><span class="nx">stepCadence</span><span class="p">.</span><span class="nx">qty</span> <span class="o">&amp;&amp;</span> <span class="p">{</span><span class="nx">workout_stepCadence_spm</span><span class="o">:</span> <span class="nx">workout</span><span class="p">.</span><span class="nx">stepCadence</span><span class="p">.</span><span class="nx">qty</span><span class="p">}),</span> <span class="c1">//1.449</span>
            <span class="p">...(</span><span class="nx">workout</span><span class="p">.</span><span class="nx">totalEnergy</span><span class="p">.</span><span class="nx">qty</span> <span class="o">&amp;&amp;</span> <span class="p">{</span><span class="nx">workout_totalEnergy_kJ</span><span class="o">:</span> <span class="nx">workout</span><span class="p">.</span><span class="nx">totalEnergy</span><span class="p">.</span><span class="nx">qty</span><span class="p">}),</span> <span class="c1">//1723.616</span>
            <span class="p">...(</span><span class="nx">workout</span><span class="p">.</span><span class="nx">maxHeartRate</span><span class="p">.</span><span class="nx">qty</span> <span class="o">&amp;&amp;</span> <span class="p">{</span><span class="nx">workout_maxHeartRate_bpm</span><span class="o">:</span> <span class="nx">workout</span><span class="p">.</span><span class="nx">maxHeartRate</span><span class="p">.</span><span class="nx">qty</span><span class="p">}),</span> <span class="c1">//170</span>
            <span class="p">...(</span><span class="nx">workout</span><span class="p">.</span><span class="nx">stepCount</span><span class="p">.</span><span class="nx">qty</span> <span class="o">&amp;&amp;</span> <span class="p">{</span><span class="nx">workout_stepCount_steps</span><span class="o">:</span> <span class="nx">workout</span><span class="p">.</span><span class="nx">stepCount</span><span class="p">.</span><span class="nx">qty</span><span class="p">}),</span> <span class="c1">//3081</span>
            <span class="p">...(</span><span class="nx">workout</span><span class="p">.</span><span class="nx">distance</span><span class="p">.</span><span class="nx">qty</span> <span class="o">&amp;&amp;</span> <span class="p">{</span><span class="nx">workout_distance_km</span><span class="o">:</span> <span class="nx">workout</span><span class="p">.</span><span class="nx">distance</span><span class="p">.</span><span class="nx">qty</span><span class="p">}),</span> <span class="c1">//0</span>
            <span class="p">...(</span><span class="nx">workout</span><span class="p">.</span><span class="nx">activeEnergy</span><span class="p">.</span><span class="nx">qty</span> <span class="o">&amp;&amp;</span> <span class="p">{</span><span class="nx">workout_activeEnergy_kJ</span><span class="o">:</span> <span class="nx">workout</span><span class="p">.</span><span class="nx">activeEnergy</span><span class="p">.</span><span class="nx">qty</span><span class="p">}),</span> <span class="c1">//1471</span>
            <span class="p">...(</span><span class="nx">workout</span><span class="p">.</span><span class="nx">elevation</span><span class="p">.</span><span class="nx">ascent</span> <span class="o">&amp;&amp;</span> <span class="p">{</span><span class="nx">workout_elevationAscent_m</span><span class="o">:</span> <span class="nx">workout</span><span class="p">.</span><span class="nx">elevation</span><span class="p">.</span><span class="nx">ascent</span><span class="p">}),</span> <span class="c1">//0</span>
            <span class="p">...(</span><span class="nx">workout</span><span class="p">.</span><span class="nx">elevation</span><span class="p">.</span><span class="nx">descent</span> <span class="o">&amp;&amp;</span> <span class="p">{</span><span class="nx">workout_elevationDescent_m</span><span class="o">:</span> <span class="nx">workout</span><span class="p">.</span><span class="nx">elevation</span><span class="p">.</span><span class="nx">descent</span><span class="p">}),</span> <span class="c1">//0</span>
        <span class="p">},</span>
        <span class="nx">tags</span><span class="o">:</span><span class="p">{</span>
            <span class="nx">workout_type</span><span class="o">:</span> <span class="nx">workout</span><span class="p">.</span><span class="nx">name</span> <span class="c1">//Fitness Gaming</span>
        <span class="p">},</span>
        <span class="nx">timestamp</span><span class="o">:</span> <span class="nb">Date</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">workout</span><span class="p">.</span><span class="nx">start</span><span class="p">)</span> 
    <span class="p">}))</span>
    <span class="p">.</span><span class="nx">filter</span><span class="p">(</span><span class="nx">e</span> <span class="p">=&gt;</span> <span class="nb">Object</span><span class="p">.</span><span class="nx">keys</span><span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">fields</span><span class="p">).</span><span class="nx">length</span><span class="p">)</span> <span class="c1">// only return entries with fields</span>

<span class="k">return</span> <span class="nx">msg</span><span class="p">;</span>
</code></pre></div>
Having set up both mappers my Node RED flow looks like this:</p>
<p><img alt="Node RED Health Export with workouts" src="../images/node-red-health-export-with-workouts.png" /></p>
                
                  
                
              
              
                


  <h2 id="__comments">Comments</h2>
  <div id="disqus_thread"></div>
  <script>var disqus_config=function(){this.page.url="https://sixtymeters.com/automations/exporting-apple-health-data-to-home-assistant/",this.page.identifier="/automations/exporting-apple-health-data-to-home-assistant/"};window.addEventListener("load",function(){var e=document,i=e.createElement("script");i.src="//aerobless-smart-home.disqus.com/embed.js",i.setAttribute("data-timestamp",+new Date),(e.head||e.body).appendChild(i)})</script>

              
            </article>
          </div>
        </div>
        
      </main>
      
        
<footer class="md-footer">
  
    <nav class="md-footer__inner md-grid" aria-label="Footer">
      
        <a href="../examples/" class="md-footer__link md-footer__link--prev" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              Automation Examples
            </div>
          </div>
        </a>
      
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
        
      </div>
      
  <div class="md-footer-social">
    
      
      
        
        
      
      <a href="https://github.com/aerobless" target="_blank" rel="noopener" title="github.com" class="md-footer-social__link">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 480 512"><path d="M186.1 328.7c0 20.9-10.9 55.1-36.7 55.1s-36.7-34.2-36.7-55.1 10.9-55.1 36.7-55.1 36.7 34.2 36.7 55.1zM480 278.2c0 31.9-3.2 65.7-17.5 95-37.9 76.6-142.1 74.8-216.7 74.8-75.8 0-186.2 2.7-225.6-74.8-14.6-29-20.2-63.1-20.2-95 0-41.9 13.9-81.5 41.5-113.6-5.2-15.8-7.7-32.4-7.7-48.8 0-21.5 4.9-32.3 14.6-51.8 45.3 0 74.3 9 108.8 36 29-6.9 58.8-10 88.7-10 27 0 54.2 2.9 80.4 9.2 34-26.7 63-35.2 107.8-35.2 9.8 19.5 14.6 30.3 14.6 51.8 0 16.4-2.6 32.7-7.7 48.2 27.5 32.4 39 72.3 39 114.2zm-64.3 50.5c0-43.9-26.7-82.6-73.5-82.6-18.9 0-37 3.4-56 6-14.9 2.3-29.8 3.2-45.1 3.2-15.2 0-30.1-.9-45.1-3.2-18.7-2.6-37-6-56-6-46.8 0-73.5 38.7-73.5 82.6 0 87.8 80.4 101.3 150.4 101.3h48.2c70.3 0 150.6-13.4 150.6-101.3zm-82.6-55.1c-25.8 0-36.7 34.2-36.7 55.1s10.9 55.1 36.7 55.1 36.7-34.2 36.7-55.1-10.9-55.1-36.7-55.1z"/></svg>
      </a>
    
      
      
        
        
      
      <a href="https://twitter.com/TheodorWinter" target="_blank" rel="noopener" title="twitter.com" class="md-footer-social__link">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><path d="M459.37 151.716c.325 4.548.325 9.097.325 13.645 0 138.72-105.583 298.558-298.558 298.558-59.452 0-114.68-17.219-161.137-47.106 8.447.974 16.568 1.299 25.34 1.299 49.055 0 94.213-16.568 130.274-44.832-46.132-.975-84.792-31.188-98.112-72.772 6.498.974 12.995 1.624 19.818 1.624 9.421 0 18.843-1.3 27.614-3.573-48.081-9.747-84.143-51.98-84.143-102.985v-1.299c13.969 7.797 30.214 12.67 47.431 13.319-28.264-18.843-46.781-51.005-46.781-87.391 0-19.492 5.197-37.36 14.294-52.954 51.655 63.675 129.3 105.258 216.365 109.807-1.624-7.797-2.599-15.918-2.599-24.04 0-57.828 46.782-104.934 104.934-104.934 30.213 0 57.502 12.67 76.67 33.137 23.715-4.548 46.456-13.32 66.599-25.34-7.798 24.366-24.366 44.833-46.132 57.827 21.117-2.273 41.584-8.122 60.426-16.243-14.292 20.791-32.161 39.308-52.628 54.253z"/></svg>
      </a>
    
  </div>

    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "../..", "features": ["navigation.tabs", "toc.integrate"], "translations": {"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing"}, "search": "../../assets/javascripts/workers/search.d351de03.min.js", "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.a1609d9a.min.js"></script>
      
    
  </body>
</html>